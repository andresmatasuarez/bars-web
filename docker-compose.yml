version: '3.8'

volumes:
  bars-mysql-data:
  bars-wordpress-data:

services:
  mysql:
    image: mysql:lts
    ports:
      - ${DB_PORT}:3306
    volumes:
      - bars-mysql-data:/var/lib/mysql
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${DB_ADMIN_PASSWORD}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ADMIN_PASSWORD}

  # Serves uploads locally for fast seed data import.
  # Can be disabled after the first successful import.
  uploads-server:
    image: nginx:alpine
    volumes:
      - ./scripts/init-site/uploads:/usr/share/nginx/html:ro

  wordpress:
    build:
      context: ./docker/wordpress
      dockerfile: Dockerfile
    ports:
      - ${WORDPRESS_PORT}:80
    volumes:
      - bars-wordpress-data:/var/www/html
      - ./wp-themes/bars2013:/var/www/html/wp-content/themes/bars2013
      - ./wp-themes/bars2026:/var/www/html/wp-content/themes/bars2026
      - ./wp-plugins/bars-commons:/var/www/html/wp-content/plugins/bars-commons
      - ./wp-plugins/jury-post-type:/var/www/html/wp-content/plugins/jury-post-type
      - ./wp-plugins/movie-post-type:/var/www/html/wp-content/plugins/movie-post-type
      - ./scripts/init-site:/docker-entrypoint-init.d
    depends_on:
      mysql:
        condition: service_healthy
      uploads-server:
        condition: service_started
    healthcheck:
      test: timeout 10s bash -c ':> /dev/tcp/127.0.0.1/80' || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    environment:
      # Official WordPress image vars
      WORDPRESS_DB_HOST: mysql
      WORDPRESS_DB_NAME: ${DB_NAME}
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_TABLE_PREFIX: ${WORDPRESS_DB_TABLE_PREFIX}
      WORDPRESS_DEBUG: 1
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', false);
        define('WP_HOME', 'http://' . $$_SERVER['HTTP_HOST']);
        define('WP_SITEURL', 'http://' . $$_SERVER['HTTP_HOST']);

      # Custom vars consumed by init-entrypoint.sh
      WORDPRESS_BLOG_NAME: Festival Buenos Aires Rojo Sangre
      WORDPRESS_ADMIN_USERNAME: ${WORDPRESS_ADMIN_USERNAME}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL}
      WORDPRESS_PORT: ${WORDPRESS_PORT}

      # Seed data vars (consumed by 4-seed-data.sh)
      SEED_DATA_OLD_HOSTNAME: http://rojosangre.quintadimension.com/2.0
      SEED_DATA_NEW_HOSTNAME: http://localhost:${WORDPRESS_PORT}
